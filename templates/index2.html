<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="title">Matter Of Choice</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script>
    // Inline script to ensure subtypes are populated immediately
    window.onload = function() {
        console.log("Window loaded (inline script)");
        
        // Define subtypes
        const subtypes = {
            behavioral: [
                { value: "interpersonal_skills", text: "Interpersonal Skills" },
                { value: "ethical_dilemmas", text: "Ethical Dilemmas" },
                { value: "stress_management", text: "Stress Management" }
            ],
            study: [
                { value: "subject_mastery", text: "Subject Mastery" },
                { value: "critical_thinking", text: "Critical Thinking" },
                { value: "practical_application", text: "Practical Application" }
            ],
            hiring: [
                { value: "technical_skills", text: "Technical Skills" },
                { value: "behavioral_interview", text: "Behavioral Interview" },
                { value: "situational_judgment", text: "Situational Judgment" }
            ]
        };
        
        // Get elements
        const questionTypeSelect = document.getElementById("question_type");
        const subTypeSelect = document.getElementById("sub_type");
        
        if (questionTypeSelect && subTypeSelect) {
            // Get selected type
            const selectedType = questionTypeSelect.value || "study";
            console.log("Selected type:", selectedType);
            
            // Clear existing options
            subTypeSelect.innerHTML = "";
            
            // Add new options
            const options = subtypes[selectedType] || [];
            options.forEach(option => {
                const optionElement = document.createElement("option");
                optionElement.value = option.value;
                optionElement.textContent = window.i18n ? window.i18n.getTranslation(option.value) : option.text;
                optionElement.setAttribute("data-translate", option.value);
                subTypeSelect.appendChild(optionElement);
                console.log("Added option:", option.text);
            });
            
            // Add event listener for future changes
            questionTypeSelect.addEventListener("change", function() {
                const newSelectedType = this.value;
                console.log("Question type changed to:", newSelectedType);
                
                // Clear existing options
                subTypeSelect.innerHTML = "";
                
                // Add new options
                const newOptions = subtypes[newSelectedType] || [];
                newOptions.forEach(option => {
                    const optionElement = document.createElement("option");
                    optionElement.value = option.value;
                    optionElement.textContent = window.i18n ? window.i18n.getTranslation(option.value) : option.text;
                    optionElement.setAttribute("data-translate", option.value);
                    subTypeSelect.appendChild(optionElement);
                });
            });
        } else {
            console.error("Could not find question_type or sub_type elements");
        }
    };
    </script>
</head>
<body>
    <div class="container">
        <h1 data-translate="title">Matter Of Choice</h1>

        <div id="form-container">
            <form id="generateForm">
                <label for="language" data-translate="select_language">Language:</label>
                <select id="language" name="language" required>
                    <option value="English" data-translate="lang_english">English</option>
                    <option value="Spanish" data-translate="lang_spanish">Spanish</option>
                    <option value="French" data-translate="lang_french">French</option>
                    <option value="Mandarin Chinese" data-translate="lang_mandarin">Mandarin Chinese</option>
                    <option value="Hindi" data-translate="lang_hindi">Hindi</option>
                    <option value="Arabic" data-translate="lang_arabic">Arabic</option>
                    <option value="Bengali" data-translate="lang_bengali">Bengali</option>
                    <option value="Russian" data-translate="lang_russian">Russian</option>
                    <option value="Portuguese" data-translate="lang_portuguese">Portuguese</option>
                    <option value="Urdu" data-translate="lang_urdu">Urdu</option>
                    <option value="German" data-translate="lang_german">German</option>
                    <option value="Japanese" data-translate="lang_japanese">Japanese</option>
                    <option value="Swahili" data-translate="lang_swahili">Swahili</option>
                    <option value="Marathi" data-translate="lang_marathi">Marathi</option>
                    <option value="Telugu" data-translate="lang_telugu">Telugu</option>
                    <option value="Tamil" data-translate="lang_tamil">Tamil</option>
                    <option value="Vietnamese" data-translate="lang_vietnamese">Vietnamese</option>
                    <option value="Korean" data-translate="lang_korean">Korean</option>
                    <option value="Turkish" data-translate="lang_turkish">Turkish</option>
                </select>

                <label for="sex" data-translate="gender">Gender</label>
                <select id="sex" name="sex">
                    <option value=""></option>
                    <option value="male" data-translate="male">male</option>
                    <option value="female" data-translate="female">female</option>
                </select>

                <label for="age" data-translate="age">Age:</label>
                <select id="age" name="age">
                    <option value=""></option>
                </select>
                <script>
                    const ageSelect = document.getElementById('age');
                    for (let i = 1; i <= 100; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.text = i;
                        ageSelect.add(option);
                    }
                </script>

                <label for="subject" data-translate="subject">Subject:</label>
                <input type="text" id="subject" name="subject" required data-translate-placeholder="enter_subject">

                <label for="difficulty" data-translate="difficulty">Difficulty Level:</label>
                <select id="difficulty" name="difficulty" required>
                    <option value="normal" data-translate="normal">normal</option>
                    <option value="easy" data-translate="easy">easy</option>
                    <option value="hard" data-translate="hard">hard</option>
                </select>
<div class="form-group" id="allow-image-form-group" style="display: none;">
    <label for="allow_image" id="allow-image-container">
        <input type="checkbox" 
               id="allow_image" 
               name="allow_image" 
               onchange="this.value = this.checked.toString()"
               style="width: auto; margin-right: 8px;">
        <span data-translate="allow_image">Allow Image Generation</span>
    </label>
</div>
                <label for="question_type" data-translate="question_type">Question Type:</label>
                <select id="question_type" name="question_type" required>
                    <option value="study" data-translate="study">Study</option>
                    <option value="behavioral" data-translate="behavioral">Behavioral</option>
                    <option value="hiring" data-translate="hiring">Hiring</option>
                </select>

                <label for="sub_type" data-translate="sub_type">Sub Type:</label>
                <select id="sub_type" name="sub_type" required>
                    <!-- Default options as fallback -->
                    <option value="subject_mastery" data-translate="subject_mastery">Subject Mastery</option>
                    <option value="critical_thinking" data-translate="critical_thinking">Critical Thinking</option>
                    <option value="practical_application" data-translate="practical_application">Practical Application</option>
                </select>

                <label for="role" data-translate="role_label">Role (Will be used for analysis part):</label>
                <input type="text" id="role" name="role" value="" data-translate-placeholder="enter_role">

                <div>
                    <button id="generateButton" type="submit" data-translate="start_game">Start New Game</button>
                </div>
            </form>
            <div>
                <button id="resetButton" style="background-color: red; margin-bottom: 20px; margin-top: 40px;" data-translate="reset_game">Reset Game</button>
            </div>
        </div>

        <div id="loading-spinner" class="hidden">
            <div class="lds-ring"><div></div><div></div><div></div><div></div></div>
        </div>

        <div id="response-container" class="hidden">
            <form id="caseForm">
                <!-- Cases will be injected here by JavaScript -->
            </form>
        </div>
        
        {% for case in cases %}
            <div class="case">
                <h3>{{ case.case }}</h3>
                {% if case.generated_image_data %}
                    <img src="{{ case.generated_image_data }}" alt="{{ window.i18n.getTranslation('generated_image_alt') }}" class="case-image" />
                {% else %}
                    <p data-translate="no_image">No image available.</p>
                {% endif %}
            </div>
        {% endfor %}
    </div>

    <div id="analysis-section" class="hidden">
        <!-- Content for analysis will go here -->
    </div>

    <!-- Add translations file before main script -->
    <script src="{{ url_for('static', filename='js/translations.js') }}"></script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>

    <!-- Yandex.Metrika counter -->
    <script type="text/javascript" >
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

        ym(100023546, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true
        });
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/100023546" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->
    <script>
document.getElementById('allow_image').addEventListener('change', function() {
    const questionTypeSelect = document.getElementById('question_type');
    const studyOption = questionTypeSelect.querySelector('option[value="study"]');
});

// Handle initial state when page loads
window.addEventListener('load', () => {
    const allowImageCheckbox = document.getElementById('allow_image');
    
    // If checkbox is checked on page load, remove study option
    if (allowImageCheckbox && allowImageCheckbox.checked) {
        toggleGenerateButton(true);
    }
});

// Function to toggle the visibility of the generate button
function toggleGenerateButton(show) {
    const generateButton = document.getElementById('generateButton');
    if (show) {
        generateButton.style.display = 'block';
    } else {
        generateButton.style.display = 'none';
    }
}

// For automatic scrolling, add these attributes to your containers
document.getElementById('analysis-section').setAttribute('onchange', 'this.scrollIntoView({behavior: "smooth", block: "start"})');

// Function to update URL parameters
function updateURLParameter(param, value) {
  const url = new URL(window.location);
  url.searchParams.set(param, value);
  window.history.replaceState({}, '', url);
}

// Function to prefill form fields from URL parameters
function prefillFormFromURL() {
  const urlParams = new URLSearchParams(window.location.search);
  const language = urlParams.get('language');
  const age = urlParams.get('age');
  const sex = urlParams.get('sex');
  const subject = urlParams.get('subject');
  const difficulty = urlParams.get('difficulty');
  const question_type = urlParams.get('question_type');
  const sub_type = urlParams.get('sub_type');
  const role = urlParams.get('role');

  if (language) {
    const languageSelect = document.getElementById('language');
    languageSelect.value = language;

    // Map language to its code and update the UI language
    const languageCodeMap = {
      English: "en",
      Spanish: "es",
      French: "fr",
      "Mandarin Chinese": "zh",
      Hindi: "hi",
      Arabic: "ar",
      Bengali: "bn",
      Russian: "ru",
      Portuguese: "pt",
      Urdu: "ur",
      German: "de",
      Japanese: "ja",
      Swahili: "sw",
      Marathi: "mr",
      Telugu: "te",
      Tamil: "ta",
      Vietnamese: "vi",
      Korean: "ko",
      Turkish: "tr",
    };

    const langCode = languageCodeMap[language] || "en";
    if (window.i18n && typeof window.i18n.updateLanguage === 'function') {
      window.i18n.updateLanguage(langCode);
    }
  }

  if (age) document.getElementById('age').value = age;
  if (subject) document.getElementById('subject').value = subject;
  if (difficulty) document.getElementById('difficulty').value = difficulty;
  if (question_type) document.getElementById('question_type').value = question_type;
  if (sub_type) document.getElementById('sub_type').value = sub_type;
  if (role) document.getElementById('role').value = role;
  if (sex) document.getElementById('sex').value = sex;
}

// Add event listeners to update URL parameters when form fields change
document.getElementById('language').addEventListener('change', (e) => updateURLParameter('language', e.target.value));
document.getElementById('age').addEventListener('change', (e) => updateURLParameter('age', e.target.value));
document.getElementById('subject').addEventListener('input', (e) => updateURLParameter('subject', e.target.value));
document.getElementById('difficulty').addEventListener('change', (e) => updateURLParameter('difficulty', e.target.value));
document.getElementById('question_type').addEventListener('change', (e) => updateURLParameter('question_type', e.target.value));
document.getElementById('sub_type').addEventListener('change', (e) => updateURLParameter('sub_type', e.target.value));
document.getElementById('role').addEventListener('input', (e) => updateURLParameter('role', e.target.value));
document.getElementById('sex').addEventListener('change', (e) => updateURLParameter('sex', e.target.value));

// Prefill form fields when the page loads
window.addEventListener('load', prefillFormFromURL);

// Show the generate button when the page loads
window.addEventListener('load', () => toggleGenerateButton(true));
</script>
</body>
</html>